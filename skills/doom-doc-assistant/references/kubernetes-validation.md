# Kubernetes YAML Validation Workflow

This document describes the validation workflow for Kubernetes YAML code blocks
embedded in ACP product documentation generated by doom-doc-assistant.

---

## When to Run

Run **after** document generation (Phase 2.6) but **before** self-verification (Phase 2.7).

**Trigger condition**: The generated document contains one or more YAML code blocks
with Kubernetes resource indicators (`apiVersion:` + `kind:`).

If no K8s YAML is detected, skip this entire workflow and proceed to Phase 2.7.

---

## Step 0: Detect K8s YAML Blocks

Scan the generated document for YAML code blocks. Look for the combination of:
- ` ```yaml ` fence markers
- `apiVersion:` field
- `kind:` field with a recognizable resource type

**Skip incomplete examples**: If a YAML block contains `# ...` or `# ...` style
ellipsis comments indicating intentionally omitted content, **do not validate it**.
Incomplete examples cannot pass schema validation and are expected to be partial.

If all YAML blocks are either non-K8s or incomplete, skip to Phase 2.7.

---

## Step 1: K8s Schema Validation (Optional)

Kubernetes schema validation is **optional** for documentation examples:

1. **YAML 1.2 syntax check** (Stage 1) is usually sufficient for documentation
2. Examples are often **version-agnostic** — written to work across multiple K8s versions
3. Strict K8s schema validation may reject valid version-agnostic patterns

Ask the user:

```
The document contains Kubernetes YAML.

YAML 1.2 syntax checking will run in Stage 1. This catches syntax errors,
format issues (e.g. bare octals like 0644), and YAML 1.1 legacy patterns.

Kubernetes schema validation (Stage 2) is optional. It checks resources against
specific K8s version schemas, but may reject version-agnostic examples.

Would you like me to run K8s schema validation?
[1] Yes — validate against specific K8s version(s)
[2] No — YAML 1.2 syntax check is sufficient
```

**If user selects Yes**, ask for version(s):

```
Which K8s version(s) should I validate against?
- Single version: e.g. "1.34"
- Multiple versions: e.g. "1.33, 1.34, 1.35"
```

**If user selects No**, skip to Step 6 and report:

```
✅ YAML 1.2 syntax check only
ⓘ K8s schema validation skipped — examples are version-agnostic
```

---

## Step 2: Setup Tools

```bash
bash scripts/setup.sh
```

Idempotent — safe to re-run. Installs `ruamel.yaml` and `kubeconform` if not present.

---

## Step 3: Extract and Save YAML Blocks

Extract each complete K8s YAML block from the document and save to a temp file.
If the document contains multiple K8s resources, they can be saved as a single
multi-document YAML file using `---` separators.

```bash
cat > /tmp/doc-manifests.yaml << 'YAML'
<extracted content>
YAML
```

---

## Step 4: Stage 1 — YAML 1.2 Syntax Check

```bash
python3 scripts/yaml_check.py /tmp/doc-manifests.yaml
```

**Interpret results**:
- **Parse errors** → STOP. Report errors and ask user to fix before proceeding.
- **Warnings** (YAML 1.1 patterns like `yes`/`no`/`on`/`off`, bare octals like `0644`) →
  Report as advisory. These are real spec issues but do not block schema validation.
- **`permissions: "0644"` reported as warning** → This is a known false positive.
  Quoted strings are valid; explain to the user that this can be ignored.

---

## Step 5: Stage 2 — K8s Schema Validation (Optional)

Only run if Stage 1 passes (no parse errors) **and** user opted in during Step 1.

**Single version validation**:

```bash
kubeconform \
  -kubernetes-version <VERSION> \
  -summary \
  -output json \
  /tmp/doc-manifests.yaml
```

**Multiple versions validation** (user provided comma-separated versions):

```bash
# Validate against each version separately
for version in 1.33 1.34 1.35; do
  echo "=== Validating against K8s $version ==="
  kubeconform \
    -kubernetes-version $version \
    -summary \
    -output json \
    /tmp/doc-manifests.yaml
done
```

**Interpret multi-version results**:
- If validation passes for **all** versions → example is truly version-agnostic ✅
- If validation fails for specific versions → note which versions are affected
- If CRDs are involved → some versions may skip (see below)

Report format for multiple versions:
```
✅ K8s Schema Validation (1.33, 1.34, 1.35)
   - <N> resource(s) passed all versions
```

Or with version-specific issues:
```
⚠ K8s Schema Validation (1.33, 1.34, 1.35)
   - Deployment/my-app: failed in 1.33 (field deprecated), passed in 1.34+
   - <N> other resource(s) passed all versions
```

**If the document contains ACP custom resources (CRDs)**:
The user may have pre-generated schema files. If kubeconform reports resources
as "skipped", ask whether CRD schemas are available and add `-schema-location`:

```bash
kubeconform \
  -kubernetes-version <VERSION> \
  -schema-location default \
  -schema-location '/path/to/crd-schemas/{{ .ResourceKind }}_{{ .ResourceAPIVersion }}.json' \
  -summary \
  -output json \
  /tmp/doc-manifests.yaml
```

---

## Step 6: Report Results

Keep the report concise. Append it inline before Phase 2.7.

---

### Case A: YAML 1.2 Only (user skipped K8s schema)

**All pass**:
```
✅ YAML Validation passed (YAML 1.2 syntax only)
   - <N> resource(s) validated, 0 errors
   ⓘ K8s schema validation skipped — examples are version-agnostic
```

**Warnings only** (no errors):
```
✅ YAML Validation passed with warnings (YAML 1.2 syntax only)
   ⚠ Line 14: `mode: 0644` — bare octal, consider `0o644` in YAML 1.2
   - <N> resource(s) validated, 0 errors
   ⓘ K8s schema validation skipped — examples are version-agnostic
   (Proceed to Phase 2.7 — warnings are advisory for documentation examples)
```

**Errors found**:
```
❌ YAML Validation failed

Errors (N):
- Line 12: indentation error (expected 4 spaces, found 2)
- Line 25: mapping values are not allowed here

Would you like me to:
1. Fix automatically and re-validate
2. Keep as-is and note the issue in the document
```

---

### Case B: YAML 1.2 + K8s Schema (single version)

**All pass**:
```
✅ YAML Validation passed (K8s <VERSION>)
   - <N> resource(s) validated, 0 errors
```

**Warnings only** (no errors):
```
✅ YAML Validation passed with warnings (K8s <VERSION>)
   ⚠ Line 14: `mode: 0644` — bare octal, consider `0o644` in YAML 1.2
   - <N> resource(s) validated, 0 errors
   (Proceed to Phase 2.7 — warnings are advisory for documentation examples)
```

**Errors found**:
```
❌ YAML Validation failed (K8s <VERSION>)

Errors (N):
- Deployment/my-app (apps/v1): spec.replicas must be integer, not string (line 12)

Would you like me to:
1. Fix automatically and re-validate
2. Keep as-is and note the issue in the document
```

---

### Case C: YAML 1.2 + K8s Schema (multiple versions)

**All pass (all versions)**:
```
✅ YAML Validation passed (K8s 1.33, 1.34, 1.35)
   - <N> resource(s) validated across all versions, 0 errors
```

**Version-specific issues**:
```
⚠ YAML Validation passed with version-specific notes (K8s 1.33, 1.34, 1.35)
   - Deployment/my-app: spec.fieldXYZ deprecated in 1.33, removed in 1.34+
     → Example may need version-specific notes or separate variants
   - <N> other resource(s) passed all versions
   (Proceed to Phase 2.7 — examples are version-aware by design)
```

---

**Resources skipped**:
```
⚠ N resource(s) skipped — schema not found (likely ACP CRDs)
  If you have CRD schema files, provide the path and I will re-run with them.
  Otherwise, YAML 1.2 syntax is confirmed valid; K8s schema check was skipped.
```

---

## Completion

Only proceed to Phase 2.7 when:
- **YAML 1.2 syntax check** passes (this is non-negotiable)
- **K8s schema validation** (if run) passes, OR
- Only warnings remain (proceed, warnings are noted in report), OR
- User explicitly chooses to proceed despite errors

**Important distinction**:
- YAML 1.2 syntax errors → **Should block** — these are real spec issues
- K8s schema errors → **Context-dependent** — version-agnostic examples may intentionally use cross-version patterns
- Warnings → **Always advisory** — document them, but don't block
